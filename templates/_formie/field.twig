{% set id = field.getHtmlId(form) %}
{% set labelId = "#{id}-label" %}
{% set labelPosition = craft.formie.getLabelPosition(field, form) %}
{% set subfieldLabelPosition = craft.formie.getLabelPosition(field, form, true) %}
{% set instructionsPosition = craft.formie.getInstructionsPosition(field, form) %}

{% set inputOptions = {
    id: id,
    labelId: labelId,
    field: field,
    renderOptions: options,
} %}

{% set value = field.getFieldValue(element) %}
{% set errors = element.getErrors(field.handle) ?? null %}

{% set html %}
    {% hook 'formie.field.field-before' %}

        {% if field.renderLabel %}
            {% hook 'formie.field.field-start' %}

            {{ formieInclude('_includes/label', { position: 'above' }) }}

            {{ formieInclude('_includes/instructions', { position: 'above' }) }}

            {% hook 'formie.field.input-before' %}

                {% hook 'formie.field.input-start' %}

                {{ field.getFrontEndInputHtml(form, value, inputOptions) }}

                {% hook 'formie.field.input-end' %}

            {% hook 'formie.field.input-after' %}

            {{ formieInclude('_includes/instructions', { position: 'below' }) }}

            {{ formieInclude('_includes/label', { position: 'below' }) }}

            {% if errors %}
                {{ formieInclude('_includes/errors') }}
            {% endif %}

            {% hook 'formie.field.field-end' %}
        {% else %}
            {% hook 'formie.field.field-start' %}

                {% hook 'formie.field.input-start' %}

                {{ field.getFrontEndInputHtml(form, value, inputOptions) }}

                {% hook 'formie.field.input-end' %}

            {% if errors %}
                {{ formieInclude('_includes/errors') }}
            {% endif %}

            {% hook 'formie.field.field-end' %}
        {% endif %}

    {% hook 'formie.field.field-after' %}
{% endset %}

{% set fieldOptions = craft.formie.getFieldOptions(field, options) %}
{% set fieldAttributes = fieldOptions.attributes ?? {} %}
{% set containerAttributes = field.getContainerAttributes() ?? {} %}
{% set attributes = {
    id: "#{id}-wrap",
    class: [
        'form__field'
    ],
    data: {
        'field-config': field.getConfigJson(),
    },
    html: html,
} | merge(fieldAttributes) | merge(containerAttributes) %}

{% namespace field.namespace %}
    {{ tag(fieldOptions.fieldTag ?? options.fieldTag ?? 'div', attributes) }}
{% endnamespace %}
